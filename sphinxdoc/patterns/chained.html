
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    

    <title>4.2. Chained Example &mdash; BigJob 1.0 User Manual</title>

<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>


    
    <link rel="stylesheet" href="../_static/rtd.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/searchtools.js"></script>
    <link rel="top" title="BigJob 1.0 User Manual" href="../index.html" />
    <link rel="up" title="4. Common Usage Patterns" href="index.html" />
    <link rel="next" title="4.3. Coupled Ensembles" href="coupled.html" />
    <link rel="prev" title="4.1. Simple Ensemble" href="simple.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="coupled.html" title="4.3. Coupled Ensembles"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="simple.html" title="4.1. Simple Ensemble"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">BigJob 1.0 User Manual</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">4. Common Usage Patterns</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="chained-example">
<h1>4.2. Chained Example<a class="headerlink" href="#chained-example" title="Permalink to this headline">Â¶</a></h1>
<p>What if you had two different executables to run? What if this second set of executables had some dependencies on data from A? Can you use one BigJob to run both jobs? Yes!</p>
<p>The below example submits a set of echo jobs (set A) using BigJob, and for every successful job (with state Done), it submits another /bin/echo job (set B) to the same Pilot-Job.</p>
<p>We can think of this as A is comprised of subjobs {a1,a2,a3}, while B is comprised of subjobs {b1,b2,b3}. Rather than wait for each subjob {a1},{a2},{a3} to complete, {b1} can run as soon as {a1} is complete, or {b1} can run as soon as a slot becomes available &#8211; i.e. {a2} could finish before {a1}.</p>
<p>The code below demonstrates this behavior. As soon as there is a slot available to run a job in B (i.e. a job in A has completed), it executes the job in B. This keeps the BigJob utilization high.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pilot</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="sd">&quot;&quot;&quot; DESCRIPTION: This example shows how to run BigJob locally to execute chained tasks.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c">#------------------------------------------------------------------------------</span>
<span class="c"># Redis password and &#39;user&#39; name</span>
<span class="n">REDIS_PWD</span>   <span class="o">=</span> <span class="c"># Fill in the password to your server</span>
<span class="n">USER_NAME</span>   <span class="o">=</span> <span class="c"># Fill in your username on the resource you&#39;re running on</span>

<span class="c"># The coordination server</span>
<span class="n">COORD</span>       <span class="o">=</span> <span class="s">&quot;redis://</span><span class="si">%s</span><span class="s">@localhost:6379&quot;</span> <span class="o">%</span> <span class="n">REDIS_PWD</span>
<span class="c"># The host to run BigJob on</span>
<span class="n">HOSTNAME</span>    <span class="o">=</span> <span class="s">&quot;localhost&quot;</span>
<span class="c"># The working directory on your machine</span>
<span class="n">WORKDIR</span>     <span class="o">=</span> <span class="s">&quot;/home/</span><span class="si">%s</span><span class="s">/example1&quot;</span> <span class="o">%</span> <span class="n">USER_NAME</span>
<span class="c"># The number of jobs you want to run</span>
<span class="n">NUMBER_JOBS</span> <span class="o">=</span> <span class="mi">4</span>


<span class="c">#------------------------------------------------------------------------------</span>
<span class="c">#</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># this describes the parameters and requirements for our pilot job</span>
        <span class="n">pilot_description</span> <span class="o">=</span> <span class="n">pilot</span><span class="o">.</span><span class="n">PilotComputeDescription</span><span class="p">()</span>
        <span class="n">pilot_description</span><span class="o">.</span><span class="n">service_url</span> <span class="o">=</span> <span class="s">&quot;fork://</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">HOSTNAME</span>
        <span class="n">pilot_description</span><span class="o">.</span><span class="n">number_of_processes</span> <span class="o">=</span> <span class="mi">4</span> 
        <span class="n">pilot_description</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">=</span> <span class="n">WORKDIR</span>
        <span class="n">pilot_description</span><span class="o">.</span><span class="n">walltime</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="c"># create a new pilot job</span>
        <span class="n">pilot_compute_service</span> <span class="o">=</span> <span class="n">pilot</span><span class="o">.</span><span class="n">PilotComputeService</span><span class="p">(</span><span class="n">COORD</span><span class="p">)</span>
        <span class="n">pilotjob</span> <span class="o">=</span> <span class="n">pilot_compute_service</span><span class="o">.</span><span class="n">create_pilot</span><span class="p">(</span><span class="n">pilot_description</span><span class="p">)</span>

         <span class="c"># submit &#39;A&#39; tasks to pilot job</span>
        <span class="n">task_set_A</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_JOBS</span><span class="p">):</span>
            <span class="n">task_desc</span> <span class="o">=</span> <span class="n">pilot</span><span class="o">.</span><span class="n">ComputeUnitDescription</span><span class="p">()</span>
            <span class="n">task_desc</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="s">&#39;/bin/echo&#39;</span>
            <span class="n">task_desc</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;I am an $TASK_SET task with id $TASK_NO&#39;</span><span class="p">,</span> <span class="p">]</span>
            <span class="n">task_desc</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;TASK_SET&#39;</span><span class="p">:</span> <span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="s">&#39;TASK_NO&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span>
            <span class="n">task_desc</span><span class="o">.</span><span class="n">number_of_processes</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">task_desc</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="s">&#39;A-stdout.txt&#39;</span>
            <span class="n">task_desc</span><span class="o">.</span><span class="n">error</span>  <span class="o">=</span> <span class="s">&#39;A-stderr.txt&#39;</span>

	    <span class="c"># Submit task to PilotJob</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">pilotjob</span><span class="o">.</span><span class="n">submit_compute_unit</span><span class="p">(</span><span class="n">task_desc</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;* Submitted &#39;A&#39; task &#39;</span><span class="si">%s</span><span class="s">&#39; with id &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">get_id</span><span class="p">())</span>
            <span class="n">task_set_A</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="c"># Chaining tasks i.e submit a compute unit, when compute unit from A is successfully executed.</span>
        <span class="c"># A &#39;B&#39; task reads the content of the output file of an &#39;A&#39; task and writes it into its own</span>
        <span class="c"># output file.</span>
        <span class="n">task_set_B</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">task_set_A</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a_task</span> <span class="ow">in</span> <span class="n">task_set_A</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a_task</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;Done&quot;</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;One &#39;A&#39; task </span><span class="si">%s</span><span class="s"> finished. Launching a &#39;B&#39; task.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a_task</span><span class="o">.</span><span class="n">get_id</span><span class="p">())</span>
                    <span class="n">task_desc</span> <span class="o">=</span> <span class="n">pilot</span><span class="o">.</span><span class="n">ComputeUnitDescription</span><span class="p">()</span>
                    <span class="n">task_desc</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="s">&#39;/bin/echo&#39;</span>
                    <span class="n">task_desc</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;I am an $TASK_SET task with id $TASK_NO&#39;</span><span class="p">,</span> <span class="p">]</span>
                    <span class="n">task_desc</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;TASK_SET&#39;</span><span class="p">:</span> <span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="s">&#39;TASK_NO&#39;</span><span class="p">:</span> <span class="n">a_task</span><span class="p">}</span>
                    <span class="n">task_desc</span><span class="o">.</span><span class="n">number_of_processes</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">task_desc</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="s">&#39;B-stdout.txt&#39;</span>
                    <span class="n">task_desc</span><span class="o">.</span><span class="n">error</span>  <span class="o">=</span> <span class="s">&#39;B-stderr.txt&#39;</span>

		    <span class="c"># Submit task to Pilot Job</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="n">pilotjob</span><span class="o">.</span><span class="n">submit_compute_unit</span><span class="p">(</span><span class="n">task_desc</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s">&quot;* Submitted &#39;B&#39; task &#39;</span><span class="si">%s</span><span class="s">&#39; with id &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">get_id</span><span class="p">())</span>
                    <span class="n">task_set_B</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                    <span class="n">task_set_A</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">a_task</span><span class="p">)</span>

       <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;AN ERROR OCCURRED: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)))</span>
            <span class="c"># print a stack trace in case of an exception -</span>
            <span class="c"># this can be helpful for debugging the problem</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

      <span class="k">finally</span><span class="p">:</span>
         <span class="c"># alway try to shut down pilots, otherwise jobs might end up</span>
         <span class="c"># lingering in the queue</span>
         <span class="k">print</span> <span class="p">(</span><span class="s">&quot;Terminating BigJob...&quot;</span><span class="p">)</span>
         <span class="n">pilotjob</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
         <span class="n">pilot_compute_service</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="simple.html"
                        title="previous chapter">4.1. Simple Ensemble</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="coupled.html"
                        title="next chapter">4.3. Coupled Ensembles</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/patterns/chained.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="coupled.html" title="4.3. Coupled Ensembles"
             >next</a> |</li>
        <li class="right" >
          <a href="simple.html" title="4.1. Simple Ensemble"
             >previous</a> |</li>
        <li><a href="../index.html">BigJob 1.0 User Manual</a> &raquo;</li>
          <li><a href="index.html" >4. Common Usage Patterns</a> &raquo;</li> 
      </ul>
    </div>
<div class="footer">
    &copy; Copyright 2013, The SAGA Project.
  Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
  <br />Theme based on <a href="http://readthedocs.org/">Read The Docs</a>

</div>





  </body>
</html>